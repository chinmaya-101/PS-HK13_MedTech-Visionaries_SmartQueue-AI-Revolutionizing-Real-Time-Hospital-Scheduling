<!DOCTYPE html>
<html>
<head>
<title>MedTech Hospital System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
margin:0;
font-family:Segoe UI;
height:100vh;
display:flex;
justify-content:center;
align-items:center;
background:linear-gradient(180deg,#020617,#081a3a,#020617);
overflow:hidden;
color:white;
}

/* glowing background dots */
body::before{
content:"";
position:absolute;
width:200%;
height:200%;
background:
radial-gradient(2px 2px at 10% 20%, rgba(0,180,255,.6), transparent),
radial-gradient(2px 2px at 30% 60%, rgba(255,255,255,.4), transparent),
radial-gradient(2px 2px at 50% 40%, rgba(0,180,255,.5), transparent),
radial-gradient(2px 2px at 70% 80%, rgba(255,255,255,.3), transparent),
radial-gradient(2px 2px at 90% 30%, rgba(0,180,255,.5), transparent);
animation:dotMove 50s linear infinite;
opacity:.7;
z-index:-1;
}

/* light wave */
body::after{
content:"";
position:absolute;
width:100%;
height:100%;
background:
linear-gradient(120deg, transparent 40%, rgba(0,180,255,.08) 50%, transparent 60%),
linear-gradient(300deg, transparent 40%, rgba(99,102,241,.08) 50%, transparent 60%);
animation:lineFlow 12s linear infinite;
z-index:-2;
}

@keyframes dotMove{
0%{transform:translate(0,0);}
100%{transform:translate(-400px,-200px);}
}

@keyframes lineFlow{
0%{background-position:0 0;}
100%{background-position:1000px 1000px;}
}

.page{display:none;}

.box{
background:#0b1c3a;
padding:30px;
border-radius:18px;
width:330px;
box-shadow:0 0 25px rgba(56,189,248,.3);
}

input{
width:100%;
padding:12px;
margin:10px 0;
border:none;
border-radius:8px;
background:#020617;
color:white;
}

button{
padding:12px 20px;
border:none;
border-radius:8px;
background:linear-gradient(135deg,#38bdf8,#6366f1);
color:white;
font-weight:600;
cursor:pointer;
}

a{
color:#7dd3fc;
display:block;
margin-top:10px;
cursor:pointer;
}

h2{color:#38bdf8;text-align:center;}

.topbar{
position:absolute;
top:0;left:0;right:0;
padding:15px;
background:#0b1c3a;
font-size:20px;
font-weight:600;
}

.dashboardWrapper{
position:absolute;
top:60px;
bottom:0;
left:0;
right:0;
overflow-y:auto;
padding:20px;
}

.dashboardGrid{
display:grid;
grid-template-columns:1fr 1fr;
gap:20px;
}

@media(max-width:700px){
.dashboardGrid{grid-template-columns:1fr;}
}

.card{
background:#0b1c3a;
padding:18px;
border-radius:14px;
box-shadow:0 0 15px rgba(56,189,248,.2);
}

.card h3{
color:#38bdf8;
margin-bottom:10px;
}

.logoutBox{
margin-top:20px;
text-align:center;
}

canvas{
background:white;
border-radius:10px;
padding:10px;
}

</style>
</head>

<body>

<div id="create" class="page box">
<h2>Create Account</h2>
<input id="cu" placeholder="Username">
<input id="cp" type="password" placeholder="Password">
<input id="cc" type="password" placeholder="Confirm Password">
<button type="button" onclick="createAccount()">Create</button>
<a onclick="showPage('login')">Already have account?</a>
</div>

<div id="login" class="page box">
<h2>Login</h2>
<input id="lu" placeholder="Username">
<input id="lp" type="password" placeholder="Password">
<button type="button" onclick="loginUser()">Login</button>
</div>

<div id="patient" class="page box">
    <h2>Patient Details</h2>
    <input id="pname" placeholder="Name">
    <input id="pphone" type="tel" placeholder="Phone No.">
    <input id="pageAge" type="number" placeholder="Age">
    <input id="pdisease" placeholder="Disease">
    
    <div style="display: flex; gap: 10px;">
        <select id="pdoctor" style="flex: 1; padding:12px; border-radius:8px; background:#020617; color:white;">
            <option>Loading Doctors...</option>
        </select>
        <button type="button" onclick="openDoctorModal()" style="width: auto; padding: 0 15px;">View Dr. Info</button>
    </div>
    
    <button type="button" onclick="savePatient()" style="margin-top: 20px;">Save & Predict</button>
</div>

<div id="docModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#0f172a; padding:30px; border-radius:15px; width:400px; border: 1px solid #38bdf8; text-align:center;">
        <h2 id="modalDocName" style="color:#38bdf8;">Doctor Name</h2>
        <hr style="border:0.5px solid #1e293b; margin:15px 0;">
        <p><strong>Category:</strong> <span id="modalCategory">Adults/Surgery</span></p>
        <p><strong>Specialty:</strong> <span id="modalSpec">General</span></p>
        <p><strong>Status:</strong> <span id="modalStatus">Available</span></p>
        <p><strong>Expected Arrival:</strong> <span id="modalArrival">10:00 AM</span></p>
        
        <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
            <button onclick="closeDoctorModal()" style="background:#334155;">Keep Doctor</button>
            <button onclick="closeDoctorModal()" style="background:#ef4444;">Change Selection</button>
        </div>
    </div>
</div>

<div id="dashboard" class="page">

<div class="topbar">â˜° MedhTech AI Optimization</div>

<div class="dashboardWrapper">

<div class="dashboardGrid">

<div class="card">
<h3>Patient Details</h3>
<p>Name: <span id="dname"></span></p>
<p>Age: <span id="dage"></span></p>
<p>Phone: <span id="dphone"></span></p>
<p>Disease: <span id="ddis"></span></p>
</div>

<div class="card">
<h3>Doctor Workload</h3>
<p>Doctor: <span id="ddoc"></span></p>
<p>Utilization: <span id="docload"></span>%</p>
<p>Status: <span id="docstatus"></span></p>
</div>

<div class="card">
<h3>Queue Optimization</h3>
<p>Position: <span id="dqueue"></span></p>
<p>Predicted Wait: <span id="dwait"></span> mins</p>
<p><strong>Reporting Time: <span id="darrival" style="color:#38bdf8"></span></strong></p>
<p>Consult Time: <span id="dconsult"></span> mins</p>
</div>

<div class="card" onclick="openAIMasterModal('recommend')" style="cursor:pointer; border: 1px solid #38bdf8;">
    <h3>AI Recommendation</h3>
    <p id="recommendText">Click to see Suggestion...</p>
</div>

<div class="card" onclick="openAIMasterModal('explain')" style="cursor:pointer;">
    <h3>Explainable AI</h3>
    <p id="explainText">Click for Logic...</p>
</div>

<div class="card" style="border: 1px solid #10b981;">
    <h3 style="color:#10b981;">Doctor Busy Schedule</h3>
    <ul id="scheduleList" style="padding:0; margin:0; list-style:none;"></ul>
</div>

<div id="aiMasterModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center;">
    <div style="background:#0f172a; padding:30px; border-radius:15px; width:450px; border:2px solid #38bdf8; text-align:center; color:white;">
        <h2 id="aiModalTitle" style="color:#38bdf8;">AI Insight</h2>
        <p id="aiModalBody" style="margin-top:15px; line-height:1.5;"></p>
        <div id="doctorSuggestionBox" style="margin-top:20px; padding:15px; background:#1e293b; border-radius:10px; display:none;">
            <p><strong>AI Suggests:</strong> <span id="suggestedDocName" style="color:#fbbf24;"></span></p>
            <button onclick="changeToSuggestedDoc()" style="background:#fbbf24; color:black; margin-top:10px;">Switch to this Doctor</button>
        </div>
        <button onclick="closeAIMasterModal()" style="margin-top:20px; background:#334155;">Close</button>
    </div>
</div>

<div class="card">
<h3>Predicted Wait Trend</h3>
<canvas id="waitChart" height="150"></canvas>
</div>

<div class="card">
<h3>Live AI Reordered Queue</h3>
<ul id="queueList"></ul>
</div>

</div>

<div class="logoutBox" style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
    
    <button type="button" onclick="goBackAndClear()" style="background: #3b82f6; border: none; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Previous</button>
    
    <button type="button" onclick="submitAndSendSMS()" style="background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Submit</button>
    
    <button type="button" onclick="showPage('login')" style="padding: 10px 20px; border-radius: 5px; cursor: pointer;">Logout</button>
    
</div>

</div>
</div>

<script>
// --- GLOBAL VARIABLES & CHART ---
let currentAiData = {}; 
const ctx = document.getElementById('waitChart').getContext('2d');
const waitChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['Start'],
        datasets: [{
            label: 'Predicted Wait (mins)',
            data: [10],
            borderColor: '#38bdf8',
            borderWidth: 3
        }]
    }
});

// --- NAVIGATION ---
function showPage(id){
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    document.getElementById(id).style.display='block';
}

// --- 1. REGISTER & LOGIN ---
async function createAccount(){
    const cu = document.getElementById('cu').value;
    const cp = document.getElementById('cp').value;
    const cc = document.getElementById('cc').value;

    if(cp !== cc){ alert("Passwords do not match"); return; }
    
    try {
        let response = await fetch("http://127.0.0.1:8000/register/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: cu, password: cp })
        });
        if(response.ok) {
            alert("Account Created Successfully!");
            showPage('login');
        } else {
            let errorData = await response.json();
            alert("Error: " + errorData.detail);
        }
    } catch(err) { alert("Cannot connect to server. Is Python running?"); }
}

async function loginUser(){
    const lu = document.getElementById('lu').value;
    const lp = document.getElementById('lp').value;
    try {
        let response = await fetch("http://127.0.0.1:8000/login/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: lu, password: lp })
        });
        if(response.ok) {
            showPage('patient');
        } else {
            alert("Invalid username or password.");
        }
    } catch(err) { alert("Cannot connect to server."); }
}

// --- 2. SAVE & PREDICT ---
async function savePatient(){
    // 1. Get values from the HTML form
    const p_name = document.getElementById('pname').value;
    const p_phone = document.getElementById('pphone').value; // <--- YOU WERE MISSING THIS
    const p_age = parseInt(document.getElementById('pageAge').value) || 0;
    const p_disease = document.getElementById('pdisease').value;
    const p_doctor = document.getElementById('pdoctor').value;

    // 2. Validate
    if(!p_name || !p_phone || !p_age || !p_disease || !p_doctor) {
        alert("Please fill all fields!");
        return;
    }

    try {
        // 3. Send to Backend
        let response = await fetch("http://127.0.0.1:8000/predict/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                patient_name: p_name,
                phone_number: p_phone, // <--- AND YOU WERE MISSING THIS
                patient_age: p_age,
                disease: p_disease,
                doctor_name: p_doctor
            })
        });

        if(response.ok) {
            let data = await response.json();
            currentAiData = data;

            // 4. Update UI Texts
            document.getElementById('dname').innerText = p_name;
            document.getElementById('dphone').innerText = p_phone; // <--- SHOW PHONE ON DASHBOARD
            document.getElementById('dage').innerText = p_age;
            document.getElementById('ddis').innerText = p_disease;
            document.getElementById('ddoc').innerText = p_doctor;

            document.getElementById('dqueue').innerText = data.queue;
            document.getElementById('dwait').innerText = data.wait;
            document.getElementById('darrival').innerText = data.arrival_time;
            document.getElementById('dconsult').innerText = "10";
            document.getElementById('docload').innerText = data.load;
            document.getElementById('docstatus').innerText = data.status;
            
            document.getElementById('recommendText').innerText = data.recommend.substring(0, 40) + "...";
            // Use innerHTML instead of innerText so we can use formatting, and remove the substring cutoff
document.getElementById('explainText').innerHTML = data.explain;

            updateChart(data.wait);
            updateLiveQueue(data.live_queue);
            updateSchedule(data.live_queue);
            
            showPage('dashboard');
        } else {
            alert("Server Error. Check terminal.");
        }
    } catch(err) {
        console.error("Crash Details:", err);
        alert("Cannot connect to server. Check console (F12) for details.");
    }
}
// --- CLEAR FORM AND GO BACK ---
function goBackAndClear() {
    // 1. Clear the input boxes
    document.getElementById('pname').value = '';
    document.getElementById('pphone').value = '';
    document.getElementById('pageAge').value = '';
    document.getElementById('pdisease').value = '';
    
    // 2. Go to the correct page
    showPage('patient');
}
// --- 3. VISUALIZATIONS ---
function updateChart(wait){
    let now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    waitChart.data.labels.push(now);
    waitChart.data.datasets[0].data.push(wait);
    if(waitChart.data.labels.length > 6){
        waitChart.data.labels.shift();
        waitChart.data.datasets[0].data.shift();
    }
    waitChart.update();
}

// THIS FUNCTION WAS MISSING. I ADDED IT BACK.
function updateLiveQueue(queueData){
    let list = document.getElementById('queueList');
    list.innerHTML = ''; 
    if(!queueData) return;

    queueData.forEach((p, index) => {
        let li = document.createElement('li');
        li.style.cssText = "padding: 8px; border-bottom: 1px solid #1e293b; display: flex; justify-content: space-between;";
        
        let isCurrentUser = p.name === document.getElementById('pname').value;
        let color = isCurrentUser ? "#38bdf8" : "white";
        let weight = isCurrentUser ? "bold" : "normal";

        li.innerHTML = `
            <span style="color:${color}; font-weight:${weight}">#${index+1} ${p.name}</span>
            <span style="color:#64748b; font-size:0.9em;">Priority: ${p.score}</span>
        `;
        list.appendChild(li);
    });
}

function updateSchedule(queueData){
    let list = document.getElementById('scheduleList');
    list.innerHTML = ''; 
    if(!queueData) return;

    queueData.forEach((p, index) => {
        let li = document.createElement('li');
        li.style.cssText = "padding: 8px; border-bottom: 1px solid #1e293b; font-size: 0.9em;";
        
        let isCurrentUser = p.name === document.getElementById('pname').value;
        let color = isCurrentUser ? "#38bdf8" : "white";
        let weight = isCurrentUser ? "bold" : "normal";

        li.innerHTML = `
            <span style="color:${color}; font-weight:${weight}">#${index+1} ${p.name}</span>
            <span style="color:#a1a1aa; float:right;">${p.start_time} - ${p.end_time}</span>
        `;
        list.appendChild(li);
    });
}

// --- 4. DOCTORS & MODALS ---
async function loadDoctors() {
    try {
        let response = await fetch("http://127.0.0.1:8000/doctors/");
        let doctors = await response.json();
        let select = document.getElementById('pdoctor');
        
        select.innerHTML = '<option value="" disabled selected>Select an Available Doctor</option>';
        doctors.forEach(doc => {
            let opt = document.createElement('option');
            opt.value = doc.name;
            // I changed 'doc.specialization' to 'doc.spec' to fix the undefined error
            opt.innerText = `${doc.name} (${doc.spec}) - ${doc.status}`; 
            select.appendChild(opt);
        });
    } catch(err) { console.error("Failed to load doctors."); }
}

async function openDoctorModal() {
    const selectedName = document.getElementById('pdoctor').value;
    if(!selectedName) return alert("Please select a doctor first!");

    let response = await fetch("http://127.0.0.1:8000/doctors/");
    let doctors = await response.json();
    const docInfo = doctors.find(d => d.name === selectedName);

    if(docInfo) {
        document.getElementById('modalDocName').innerText = docInfo.name;
        document.getElementById('modalCategory').innerText = docInfo.cat;
        document.getElementById('modalSpec').innerText = docInfo.spec;
        document.getElementById('modalStatus').innerText = docInfo.status;
        document.getElementById('modalArrival').innerText = docInfo.arrival;
        document.getElementById('docModal').style.display = 'flex';
    }
}

function closeDoctorModal() { document.getElementById('docModal').style.display = 'none'; }

function openAIMasterModal(type) {
    const modal = document.getElementById('aiMasterModal');
    const docBox = document.getElementById('doctorSuggestionBox'); 

    if (type === 'recommend') {
        document.getElementById('aiModalTitle').innerText = "AI Recommendation Engine";
        document.getElementById('aiModalBody').innerText = currentAiData.recommend || "No data yet.";
        const docName = currentAiData.suggested_doctor || "";
        document.getElementById('suggestedDocName').innerText = docName;
        docBox.style.display = docName ? "block" : "none";
    } else {
        document.getElementById('aiModalTitle').innerText = "Explainable AI (XAI)";
        document.getElementById('aiModalBody').innerText = currentAiData.explain || "No data yet.";
        docBox.style.display = "none";
    }
    modal.style.display = 'flex';
}

function closeAIMasterModal() { document.getElementById('aiMasterModal').style.display = 'none'; }

function changeToSuggestedDoc() {
    const newDoc = currentAiData.suggested_doctor.split(" (")[0]; 
    document.getElementById('ddoc').innerText = newDoc;
    alert("Doctor reassigned to " + newDoc + " to optimize queue!");
    closeAIMasterModal();
}

// --- 5. SEND SMS FUNCTION ---
async function submitAndSendSMS() {
    // Grab the details currently showing on the dashboard
    const p_phone = document.getElementById('dphone').innerText;
    const p_name = document.getElementById('dname').innerText;
    const wait = document.getElementById('dwait').innerText;
    const doctor = document.getElementById('ddoc').innerText;

    if(!p_phone) {
        alert("No phone number found to send SMS!");
        return;
    }

    try {
        let response = await fetch("http://127.0.0.1:8000/send-sms/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                phone_number: p_phone,
                patient_name: p_name,
                wait_time: wait,
                doctor_name: doctor
            })
        });

        if(response.ok) {
            alert("Submitted Successfully! SMS has been sent to the patient.");
        } else {
            alert("Submitted Successfully, but failed to send SMS. Check your Twilio credentials.");
        }
    } catch(err) {
        console.error(err);
        alert("Cannot connect to server for SMS.");
    }
}

// Start app
loadDoctors(); 
showPage('create');
</script>
</body>
</html>